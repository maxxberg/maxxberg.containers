---
# tasks file for podman_service_deploy
# SPDX-License-Identifier: MIT-0
- name: Reset variables
  ansible.builtin.set_fact:
    podman_service_requires: []
    podman_service_networks: []

- name: Create directory
  ansible.builtin.file:
    path: "{{ project_dir }}"
    state: directory
    mode: "0755"

- name: Multiblock
  block:
    - name: Podman - Networks
      containers.podman.podman_network:
        name: "{{ item.name }}"
        internal: "{{ item.internal }}"
        state: present
      with_items: "{{ podman_service_deploy_config.networks }}"

    - name: Podman - Secrets
      containers.podman.podman_secret:
        name: "{{ project_name }}_secrets"
        data: |
          apiVersion: v1
          data:
          {% for secret in podman_service_deploy_config.secrets %}
            {{ secret.name }}: {{ secret.value | b64encode }}
          {% endfor %}
          kind: Secret
          metadata:
            name: {{ project_name }}_secrets
      when: podman_service_deploy_config.secrets is defined and podman_service_deploy_config.secrets|length > 0

    - name: Create volumes
      containers.podman.podman_volume:
        name: "{{ item }}"
        state: present
      with_items: "{{ podman_service_deploy_config.volumes }}"
      when: podman_service_deploy_config.volumes is defined

    # - name: Assemble input_files
    #   ansible.builtin.set_fact:
    #     input_files: "{{ podman_service_deploy_config.kube_files }}"

    - name: Template kube file
      ansible.builtin.template:
        src: ../shared/templates/concat_variable.j2
        dest: "{{ project_dir }}/{{ project_name }}.kube"
        mode: "0644"
      vars:
        input_files: "{{ podman_service_deploy_config.kube_files }}"

    - name: Prepare network list
      ansible.builtin.set_fact:
        podman_service_networks: "{{ (podman_service_networks | default([])) + [item.name] }}"
      with_items: "{{ podman_service_deploy_config.networks }}"

    - name: Prepare service dependencies
      ansible.builtin.set_fact:
        podman_service_requires: []

    - name: Add mariadb to service dependencies
      ansible.builtin.set_fact:
        podman_service_requires: "{{ podman_service_requires + [db_name] }}"
      when: db_name is defined

    - name: Create Quadlet
      containers.podman.podman_play:
        kube_file: "{{ project_dir }}/{{ project_name }}.kube"
        quadlet_filename: "{{ project_name }}"
        network: "{{ podman_service_networks }}"
        quadlet_options: |
            [Install]
            WantedBy=default.target
            [Unit]
            {% for service in podman_service_requires %}
            Requires={{ service }}.service
            {% endfor %}
        state: quadlet

# END OF BLOCK

- name: Set mariadb_network (Needed because of lazy evaluation)
  ansible.builtin.set_fact:
    db_networks: "{{ podman_service_deploy_config.mariadb.networks }}"
  when: podman_service_deploy_config.mariadb is defined

- name: Include Mariadb
  ansible.builtin.include_role:
    name: .mariadb
  vars:
    mariadb_name: "{{ podman_service_deploy_config.mariadb.name }}"
    mariadb_networks: "{{ db_networks }}"
    mariadb_user: "{{ podman_service_deploy_config.mariadb.user }}"
    mariadb_password: "{{ podman_service_deploy_config.mariadb.password }}"
    mariadb_root_password: "{{ podman_service_deploy_config.mariadb.root_password }}"
    mariadb_image_tag: "{{ podman_service_deploy_config.mariadb.image_tag | mandatory }}"
    mariadb_args: "{{ podman_service_deploy_config.mariadb.args | default() }}"
  when: podman_service_deploy_config.mariadb is defined
