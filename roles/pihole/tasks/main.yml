---
# tasks file for maxxberg.pihole

- name: Docker - Create volumes
  docker_volume:
    name: "{{ item }}"
    state: present
  loop:
    - pihole_conf
    - pihole_dnsmasq

- name: Create project directotory
  ansible.builtin.file:
    path: docker-compose/pihole
    state: directory
    mode: "0755"

- name: Create docker-compose.yaml
  ansible.builtin.template:
    src: docker-compose.yaml.j2
    dest: docker-compose/pihole/docker-compose.yaml
    force: true
    mode: "0755"

- name: Create docker networks - intranet
  community.docker.docker_network:
    name: intranet
    internal: true
    state: present
    ipam_config:
      - subnet: "{{ intranet_network | mandatory }}"


- name: Create dnsmasq config
  ansible.builtin.copy:
    dest: "{{ data_path | default('/var/lib/docker/') + 'volumes/pihole_dnsmasq/_data/02-custom.conf' }}"
    content: |
      all-servers
    mode: "0755"
  when: container_engine == 'docker'

- name: Create dnsmasq config
  ansible.builtin.copy:
    dest: "{{ data_path | default('/var/lib/containers/storage/') + 'volumes/pihole_dnsmasq/_data/02-custom.conf' }}"
    content: |
      all-servers
    mode: "0755"
  when: container_engine == 'podman'

# - name: Create dnsmasq config
#   copy:
#     dest: docker-compose/pihole/dnsmasq.conf
#     content: |
#       #dont use hosts nameservers
#       no-resolv
#       #use google as default nameservers
#       server=9.9.9.11
#       server=9.9.9.9
#       server=1.1.1.1


- name: Docker - pull image
  community.docker.docker_image:
    name: docker.io/pihole/pihole:latest
    state: present
    source: pull

- name: Disable systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved
    state: stopped
    enabled: false
  when:
    - state == "present"
    - is_home_network

- name: Enable systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved
    state: started
    enabled: true
  when:
    - state == "absent"
    - not is_home_network

- name: Docker - pihole
  community.docker.docker_compose:
    project_src: docker-compose/pihole/
    state: present
